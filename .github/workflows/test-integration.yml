name: Integration Tests

on:
  push:
    branches:
      - feature/polymarket-web-app
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  FUNCTION_APP_NAME: polymarket-analyzer
  STATIC_APP_NAME: polymarket-web-ui

jobs:
  test-api:
    runs-on: ubuntu-latest
    name: Test API Integration
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "FUNCTION_APP_NAME=${{ env.FUNCTION_APP_NAME }}" > .env
          echo "STATIC_APP_NAME=${{ env.STATIC_APP_NAME }}" >> .env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run API Integration Tests
        run: |
          bash integration-tests/test-api-flow.sh

      - name: Test Results Summary
        if: always()
        run: |
          echo "### ðŸ§ª API Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

  test-ui:
    runs-on: ubuntu-latest
    name: Test UI Integration
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "FUNCTION_APP_NAME=${{ env.FUNCTION_APP_NAME }}" > .env
          echo "STATIC_APP_NAME=${{ env.STATIC_APP_NAME }}" >> .env
          echo "RESOURCE_GROUP=AZAI_group" >> .env

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run UI Integration Tests
        run: |
          bash integration-tests/test-ui-flow.sh

      - name: Test Results Summary
        if: always()
        run: |
          echo "### ðŸŽ¨ UI Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

  health-check:
    runs-on: ubuntu-latest
    name: Health Check All Services
    needs: [test-api, test-ui]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "FUNCTION_APP_NAME=${{ env.FUNCTION_APP_NAME }}" > .env
          echo "STATIC_APP_NAME=${{ env.STATIC_APP_NAME }}" >> .env
          echo "RESOURCE_GROUP=AZAI_group" >> .env
          echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run Health Checks
        run: |
          bash scripts/health-check-all.sh

      - name: Health Check Summary
        if: always()
        run: |
          echo "### â¤ï¸ System Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** https://${{ env.FUNCTION_APP_NAME }}.azurewebsites.net/api/health" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
